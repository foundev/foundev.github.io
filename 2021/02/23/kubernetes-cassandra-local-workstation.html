<hr />
<p>layout: post
title: Getting the DataStax cass-operator working on Mac
tags: [cassandra, kubernetes]</p>
<hr />
<p>Just leaving this here for anyone coming back to this later. This works as of Feb 23 2021 on Big Sur</p>
<ul>
<li>install docker desktop https://www.docker.com/products/docker-desktop</li>
<li>install k3d https://github.com/rancher/k3d#get you can just run <code>curl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash</code></li>
<li>create cluster: <code>k3d cluster create</code></li>
<li>install operator manifest <code>kubectl create -f https://raw.githubusercontent.com/datastax/cass-operator/v1.5.1/docs/user/cass-operator-manifests-v1.19.yaml</code></li>
<li>download a cassandra data center yaml <code>curl -O https://gist.githubusercontent.com/rsds143/0e9263ed4287d888fab36eb3e4aec502/raw/f919172c64452a2277b7523d680a9e12916d0d39/cassandra-dc.yaml</code></li>
<li>run <code>kubectl create -f cassandra-dc.yaml --namespace cass-operator</code></li>
<li>wait for cassandra to come up <code>kubectl logs cluster1-dc1-default-sts-0 --namespace cass-operator server-system-logger</code></li>
<li>get username <code>export CQLUSER=$(kubectl get secret cluster1-superuser -o json -n cass-operator | grep \"username\"  | sed -E 's/\"(.+)\": \"(.+)\"/\2/' | base64 -d)</code></li>
<li>get password <code>export CQLPASS=$(kubectl get secret cluster1-superuser -o json -n cass-operator | grep \"password\"  | sed -E 's/\"(.+)\": \"(.+)\"/\2/' | sed -E 's/,*$//g' | base64 -d )</code></li>
<li>log into cqlsh <code>kubectl exec -it -n cass-operator cluster1-dc1-default-sts-0 -- cqlsh -u $CQLUSER -p $CQLPASS</code></li>
<li>enjoy your cassandra cluster</li>
</ul>
<p>The yaml I have linked too above is here</p>
<p><code>yaml
apiVersion: cassandra.datastax.com/v1beta1
kind: CassandraDatacenter
metadata:
  name: dc1
spec:
  clusterName: cluster1
  serverType: cassandra
  serverVersion: 3.11.7
  managementApiAuth:
    insecure: {}
  size: 1
  storageConfig:
    cassandraDataVolumeClaimSpec:
      storageClassName: local-path
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
  config:
    cassandra-yaml:
      authenticator: org.apache.cassandra.auth.PasswordAuthenticator
      authorizer: org.apache.cassandra.auth.CassandraAuthorizer
      role_manager: org.apache.cassandra.auth.CassandraRoleManager
    jvm-options:
      initial_heap_size: 800M
      max_heap_size: 800M</code></p>
<p>I also wrote a quick script <a href="https://gist.githubusercontent.com/rsds143/0e9263ed4287d888fab36eb3e4aec502/raw/40632aa794a8be8aa7acf17da0e35a3b47ebc04a/autostart_cassandra.sh">here</a></p>
<p>sorry you can not run it with curl -s due to <a href="https://github.com/kubernetes/kubernetes/issues/37471">this issue</a> or at least I haven't figured it out yet, but downloading it and running it works fine</p>
<p>```sh</p>
<h1>!/bin/bash</h1>
<p>echo "installing k3d"
curl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash
echo "creating k3d cluster"
k3d cluster create
echo "installing cassandra operator"
kubectl create -f https://raw.githubusercontent.com/datastax/cass-operator/v1.5.1/docs/user/cass-operator-manifests-v1.19.yaml
echo "installing cassandra data center"
curl -O https://gist.githubusercontent.com/rsds143/0e9263ed4287d888fab36eb3e4aec502/raw/f919172c64452a2277b7523d680a9e12916d0d39/cassandra-dc.yaml
kubectl create -f cassandra-dc.yaml --namespace cass-operator
echo "Sleeping for 120 secondsâ€¦"
sleep 120
echo "getting username and password"
echo "trying to login"
export CQLUSER=$(kubectl get secret cluster1-superuser -o json -n cass-operator | grep \"username\"  | sed -E 's/\"(.+)\": \"(.+)\"/\2/' | base64 -d)
export CQLPASS=$(kubectl get secret cluster1-superuser -o json -n cass-operator | grep \"password\"  | sed -E 's/\"(.+)\": \"(.+)\"/\2/' | sed -E 's/,*$//g' | base64 -d )
kshell() {
kubectl exec -it -n cass-operator cluster1-dc1-default-sts-0 -- cqlsh -u $CQLUSER -p $CQLPASS
}
kshell
```</p>