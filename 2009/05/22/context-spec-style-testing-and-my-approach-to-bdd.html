---
title: Context and Spec style testing and my approach to BDD
date: 2009-05-22T00:21:00+00:00
author: Ryan Svihla
layout: post
tags: [csharp, testing]
---
<p><em>EDIT: this is an old post copied over from my <a href="https://lostechies.com/ryansvihla/2009/05/22/context-spec-style-testing-and-my-approach-to-bdd/">old blog on Los Techies</a>, I have kept it here for archival reasons.</em></p>
<p>I borrow heavily my approach to testing from a combination of Ayende's <a href="http://rhino-tools.svn.sourceforge.net/viewvc/rhino-tools/trunk/">Rhino Tools</a> tests, and my reading of the <a href="http://www.pragprog.com/titles/achbd/the-rspec-book">Rspec</a> beta book. But I think I've stumbled onto something I'm happy with and I can generate reports out of. Let's go over some basic rules first:</p>
<ol>
<li>Move as much common setup logic to a base class as possible. </li>
<li>Use your class name as the context </li>
<li>methods are rules beginning with should; </li>
<li>create a new subclass of the base context every time you have a new scenario</li>
</ol>
<p>Code ends up looking like so: </p>
<p>```csharp
public class BaseAddVacationContext
    {
        protected AddVacationRequest _submission;
        protected IEmailSender _sender;
        protected IUserInformation _information;
        protected ICrudRepo<LeaveRequest> _leaverepo;
        protected LeaveRequest _request;</p>
<pre><code>    [SetUp]
    public virtual void SetUp()
    {
        _sender = MockRepository.GenerateMock&lt;IEmailSender&gt;();
        _information = MockRepository.GenerateMock&lt;IUserInformation&gt;();
        _leaverepo = MockRepository.GenerateMock&lt;ICrudRepo&lt;LeaveRequest&gt;&gt;();
        _submission = new AddVacationRequest(_sender, _information, _leaverepo);
        _request = new LeaveRequest() { UserName = "userman" };


    }
}
[TestFixture]
public class SpecAddVacationRequestWhenEmployeeSubmitsRequest : BaseAddVacationContext
{

    [SetUp]
    public override void SetUp()
    {
        base.SetUp();
        _information.Stub(x =&gt; x.GetManagersEmailAddresses("userman")).Return(new[] { "manager1@jonbank.com", "manager2@jonbank.com" });
        _information.Stub(x =&gt; x.GetReviewersEmailAddress("userman")).Return(new[] { "james@jonbank.com", "jones@jonbank.com" });
        _information.Stub(x =&gt; x.GetUserEmail("userman")).Return("userman@jonbank.com");
        _submission.Execute(_request);

    }

    [Test]
    public void should_email_all_managers()
    {
        _sender.AssertWasCalled(x =&gt; x.Send(Arg&lt;Message&gt;.Matches(y =&gt; y.To == "manager1@jonbank.com")));
        _sender.AssertWasCalled(x =&gt; x.Send(Arg&lt;Message&gt;.Matches(y =&gt; y.To == "manager2@jonbank.com")));
    }

    [Test]
    public void should_send_email_to_user()
    {
        _sender.AssertWasCalled(x =&gt; x.Send(Arg&lt;Message&gt;.Matches(y =&gt; y.To == "userman@jonbank.com")));
    }

    [Test]
    public void should_store_leave_request_in_database()
    {
        _leaverepo.AssertWasCalled(x=&gt;x.Create(Arg&lt;LeaveRequest&gt;.Matches(u=&gt;u == _request)));
    }

    [Test]
    public void should_email_all_reviewers()
    {
        _sender.AssertWasCalled(x =&gt; x.Send(Arg&lt;Message&gt;.Matches(y =&gt; y.To == "jones@jonbank.com")));
        _sender.AssertWasCalled(x =&gt; x.Send(Arg&lt;Message&gt;.Matches(y =&gt; y.To == "james@jonbank.com")));
    }
}
[TestFixture]
public class SpecAddVacationRequestWhenRequesWasAlreadyMadeForThoseDays : BaseAddVacationContext
{

    [SetUp]
    public override void SetUp()
    {
        base.SetUp();

        _leaverepo.Stub(x=&gt;x.Create(null)).Throw(new EmployeeAlreadyRequestedTheseDaysOff()).IgnoreArguments();
     }
     [Test]
     public void should_not_send_email_to_anyone()
 {

       _sender.AssertWasNotCalled(x =&gt; x.Send(Arg&lt;Message&gt;.Is.Anything));
     }
}
</code></pre>
<p>```</p>
<p>So here we have: </p>
<ul>
<li>A setup that you need to override and call to setup context specific behavior </li>
<li>small small tests and asserts. </li>
<li>limited setup on mocks, you can use handrolled mocks or the real classes if you prefer (which I do often).</li>
<li>Use AssertWasCalled instead of .Expect() on my mocks</li>
</ul>
<p>I'll post more examples of this as they come up.</p>